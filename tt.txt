using System.Runtime.InteropServices;
using NAudio.Wave;

namespace AudioProApp;

public partial class Form1 : Form
{
    // --- SILNIKI ---
    [DllImport("winmm.dll", CharSet = CharSet.Auto)]
    static extern bool PlaySound(string pszSound, IntPtr hmod, uint fdwSound);

    private dynamic wmp; // ActiveX
    private IWavePlayer waveOut = new WaveOutEvent(); // NAudio
    private AudioFileReader audioReader;

    // PLIKI (szukaj w folderze obok kodu)
    private string wav = "test.wav";
    private string mp3 = "test.mp3";

    // UI - Pole tekstowe na pełny nagłówek
    private TextBox txtHeaderInfo;

    public Form1()
    {
        this.Text = "Zaawansowany Odtwarzacz .NET 10";
        this.Size = new Size(600, 750); // Większe okno
        this.StartPosition = FormStartPosition.CenterScreen;

        // Start ActiveX
        try { wmp = Activator.CreateInstance(Type.GetTypeFromProgID("WMPlayer.OCX.7")); } catch { }

        BudujInterfejs();
    }

    private void BudujInterfejs()
    {
        int startY = 20;

        // --- RZĄD 1: PlaySound ---
        DodajNapis("1. PlaySound (WinAPI)", startY);
        Button b1 = DodajPrzycisk("Graj WAV", startY + 30, 20);
        b1.Click += (s, e) => PlaySound(wav, IntPtr.Zero, 0x0001 | 0x0002);

        Button b2 = DodajPrzycisk("STOP (Null)", startY + 30, 150);
        b2.Click += (s, e) => PlaySound(null, IntPtr.Zero, 0); // Zatrzymanie przez NULL

        // --- RZĄD 2: NAGŁÓWEK WAV (Pełny) ---
        startY += 100;
        DodajNapis("2. Pełny Nagłówek i Dane Pliku WAV", startY);
        
        txtHeaderInfo = new TextBox { 
            Top = startY + 30, Left = 20, Width = 540, Height = 180, 
            Multiline = true, ReadOnly = true, ScrollBars = ScrollBars.Vertical,
            Font = new Font("Consolas", 9) // Czcionka programistyczna - czytelniejsza
        };
        this.Controls.Add(txtHeaderInfo);

        Button bInfo = DodajPrzycisk("Pobierz Pełne Info", startY + 220, 20);
        bInfo.Width = 230;
        bInfo.Click += (s, e) => PokazPelnyNaglowek();

        // --- RZĄD 3: ActiveX ---
        startY += 280;
        DodajNapis("3. ActiveX (Media Player - Szybkość)", startY);
        Button b3 = DodajPrzycisk("Graj MP3", startY + 30, 20);
        b3.Click += (s, e) => { wmp.URL = mp3; wmp.controls.play(); };

        Button b4 = DodajPrzycisk("Szybko 2.0x", startY + 30, 150);
        b4.Click += (s, e) => wmp.settings.rate = 2.0;

        // --- RZĄD 4: NAudio (Pauza/Wznowienie) ---
        startY += 100;
        DodajNapis("4. NAudio (Zapamiętywanie pozycji)", startY);
        
        Button bPlay = DodajPrzycisk("START / WZNÓW", startY + 30, 20);
        bPlay.Click += (s, e) => {
            if (audioReader == null) {
                audioReader = new AudioFileReader(mp3);
                waveOut.Init(audioReader);
            }
            waveOut.Play(); // Jeśli było zapauzowane, ruszy od tego samego momentu
        };

        Button bPause = DodajPrzycisk("PAUZA", startY + 30, 150);
        bPause.Click += (s, e) => waveOut.Pause(); // Stopuje, ale nie kasuje pozycji

        Button bReset = DodajPrzycisk("RESTART", startY + 30, 280);
        bReset.Click += (s, e) => {
            waveOut.Stop();
            if (audioReader != null) audioReader.Position = 0; // Przewiń na start
        };
    }

    private void PokazPelnyNaglowek()
    {
        try {
            using (var reader = new WaveFileReader(wav)) {
                var f = reader.WaveFormat;
                var info = new System.Text.StringBuilder();
                info.AppendLine($"--- NAGŁÓWEK GŁÓWNY (fmt) ---");
                info.AppendLine($"Kodowanie: {f.Encoding}");
                info.AppendLine($"Kanały: {f.Channels}");
                info.AppendLine($"Próbkowanie: {f.SampleRate} Hz");
                info.AppendLine($"Bity na próbkę: {f.BitsPerSample} bit");
                info.AppendLine($"Bajtów na sekundę: {f.AverageBytesPerSecond}");
                info.AppendLine($"Wyrównanie bloku: {f.BlockAlign}");
                info.AppendLine("");
                info.AppendLine($"--- DANE PLIKU ---");
                info.AppendLine($"Czas trwania: {reader.TotalTime}");
                info.AppendLine($"Długość w bajtach: {reader.Length} bytes");
                
                // Dodatkowe metadane (Extra Chunks) jeśli istnieją
                if (reader.ExtraChunks.Count > 0) {
                    info.AppendLine("");
                    info.AppendLine($"--- DODATKOWE SEKCJE (Chunks) ---");
                    foreach(var chunk in reader.ExtraChunks)
                        info.AppendLine($"Chunk ID: {chunk.IdentifierAsString} | Rozmiar: {chunk.ChunkLength}");
                }

                txtHeaderInfo.Text = info.ToString();
            }
        } catch {
            txtHeaderInfo.Text = "BŁĄD: Nie można odczytać pliku test.wav.\nUpewnij się, że plik jest w folderze projektu.";
        }
    }

    // Pomocnik: Przycisk z wysokością minimum 40
    private Button DodajPrzycisk(string tekst, int gora, int lewo) {
        Button b = new Button { 
            Text = tekst, Top = gora, Left = lewo, 
            Width = 120, Height = 45, // Zwiększona wysokość
            BackColor = Color.LightGray,
            FlatStyle = FlatStyle.Flat
        };
        this.Controls.Add(b);
        return b;
    }

    private void DodajNapis(string tekst, int gora) {
        Label l = new Label { Text = tekst, Top = gora, Left = 20, AutoSize = true, Font = new Font("Segoe UI", 10, FontStyle.Bold) };
        this.Controls.Add(l);
    }
}