using System.Runtime.InteropServices;
using System.IO; // Potrzebne do obsługi ścieżek Path
using NAudio.Wave;

namespace AudioProApp;

public partial class Form1 : Form
{
    // --- 1. PlaySound (WinAPI) ---
    [DllImport("winmm.dll", CharSet = CharSet.Auto)]
    static extern bool PlaySound(string? pszSound, IntPtr hmod, uint fdwSound);

    // --- 2. ActiveX (Windows Media Player) ---
    // Zmieniamy typ na 'dynamic', żeby kompilator nie szukał biblioteki WMPLib
    private dynamic? wmp; 

    // --- 3. NAudio ---
    private IWavePlayer waveOut = new WaveOutEvent();
    private AudioFileReader? audioReader;

    // Ścieżki do plików (szuka ich w folderze z programem)
    private readonly string _wavPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "test.wav");
    private readonly string _mp3Path = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "test.mp3");

    public Form1()
    {
        this.Text = "Odtwarzacz Audio .NET 10";
        this.Size = new Size(500, 450);
        this.StartPosition = FormStartPosition.CenterScreen;

        // Inicjalizacja ActiveX bez użycia bibliotek (tzw. Late Binding)
        try {
            Type? type = Type.GetTypeFromProgID("WMPlayer.OCX.7");
            if (type != null) {
                wmp = Activator.CreateInstance(type);
            }
        } catch {
            // Jeśli ktoś nie ma zainstalowanego WMP w systemie
        }

        InitializeLayout();
    }

    private void InitializeLayout()
    {
        int startY = 20;

        // --- RZĄD 1: PlaySound ---
        AddLabel("Model 1: PlaySound (Systemowy WinAPI)", startY);
        Button btnPlaySound = CreateButton("Graj WAV", startY + 30, 20);
        btnPlaySound.Click += (s, e) => {
            if (File.Exists(_wavPath)) PlaySound(_wavPath, IntPtr.Zero, 0x0001 | 0x0002);
            else MessageBox.Show("Nie znaleziono pliku test.wav");
        };

        // --- RZĄD 2: ActiveX (Dynamiczny) ---
        startY += 100;
        AddLabel("Model 2: ActiveX (WMP - dynamic)", startY);
        Button btnWmpPlay = CreateButton("Graj MP3", startY + 30, 20);
        btnWmpPlay.Click += (s, e) => {
            if (wmp != null && File.Exists(_mp3Path)) {
                wmp.URL = _mp3Path;
                wmp.controls.play();
            } else MessageBox.Show("Problem z ActiveX lub brakiem pliku test.mp3");
        };

        Button btnWmpSlow = CreateButton("Wolniej (0.5x)", startY + 30, 130);
        btnWmpSlow.Click += (s, e) => { if (wmp != null) wmp.settings.rate = 0.5; };

        Button btnWmpFast = CreateButton("Szybciej (2.0x)", startY + 30, 240);
        btnWmpFast.Click += (s, e) => { if (wmp != null) wmp.settings.rate = 2.0; };

        // --- RZĄD 3: NAudio ---
        startY += 100;
        AddLabel("Model 3: NAudio (Biblioteka NuGet)", startY);
        Button btnNaudioPlay = CreateButton("Graj MP3", startY + 30, 20);
        btnNaudioPlay.Click += (s, e) => {
            if (File.Exists(_mp3Path)) {
                if (audioReader != null) audioReader.Dispose();
                audioReader = new AudioFileReader(_mp3Path);
                waveOut.Init(audioReader);
                waveOut.Play();
            }
        };

        Button btnNaudioStop = CreateButton("Stop", startY + 30, 130);
        btnNaudioStop.Click += (s, e) => waveOut.Stop();
    }

    // Funkcje pomocnicze do budowy okna
    private Button CreateButton(string text, int top, int left) {
        Button btn = new Button { Text = text, Top = top, Left = left, Width = 100, Height = 35 };
        this.Controls.Add(btn);
        return btn;
    }

    private void AddLabel(string text, int top) {
        Label lbl = new Label { Text = text, Top = top, Left = 20, AutoSize = true, Font = new Font("Segoe UI", 10, FontStyle.Bold) };
        this.Controls.Add(lbl);
    }
}