using System.Runtime.InteropServices;
using NAudio.Wave; // Do czytania nagłówka i odtwarzania

namespace AudioProApp;

public partial class Form1 : Form
{
    // --- 1. PlaySound (WinAPI) ---
    [DllImport("winmm.dll", CharSet = CharSet.Auto)]
    static extern bool PlaySound(string pszSound, IntPtr hmod, uint fdwSound);

    // --- 2. ActiveX ---
    private dynamic wmp; 

    // --- 3. NAudio ---
    private IWavePlayer waveOut = new WaveOutEvent();
    private AudioFileReader audioReader;

    // Pliki w folderze projektu
    private string wav = "test.wav";
    private string mp3 = "test.mp3";

    // Etykieta do wyświetlania nagłówka
    private Label lblWavInfo;

    public Form1()
    {
        this.Text = "Odtwarzacz Pro .NET 10";
        this.Size = new Size(500, 500);

        try {
            wmp = Activator.CreateInstance(Type.GetTypeFromProgID("WMPlayer.OCX.7"));
        } catch { }

        InicjalizujUI();
    }

    private void InicjalizujUI()
    {
        int startY = 20;

        // --- RZĄD 1: PlaySound ---
        DodajNapis("1. PlaySound (WinAPI)", startY);
        Button b1 = DodajPrzycisk("Graj WAV", startY + 30, 20);
        b1.Click += (s, e) => PlaySound(wav, IntPtr.Zero, 0x0001 | 0x0002);

        Button b2 = DodajPrzycisk("Stop (Null)", startY + 30, 130);
        b2.Click += (s, e) => PlaySound(null, IntPtr.Zero, 0); // Zatrzymanie przez NULL

        // --- RZĄD 2: Nagłówek WAV ---
        startY += 90;
        DodajNapis("2. Nagłówek pliku WAV", startY);
        lblWavInfo = new Label { Text = "Kliknij, aby sprawdzić info...", Top = startY + 30, Left = 20, Width = 400 };
        this.Controls.Add(lblWavInfo);
        
        Button bInfo = DodajPrzycisk("Pokaż Info", startY + 55, 20);
        bInfo.Click += (s, e) => PokazNaglowekWav();

        // --- RZĄD 3: ActiveX ---
        startY += 110;
        DodajNapis("3. ActiveX (Szybkość)", startY);
        Button b3 = DodajPrzycisk("Graj MP3", startY + 30, 20);
        b3.Click += (s, e) => { wmp.URL = mp3; wmp.controls.play(); };
        
        Button b4 = DodajPrzycisk("Szybko (2x)", startY + 30, 130);
        b4.Click += (s, e) => wmp.settings.rate = 2.0;

        // --- RZĄD 4: NAudio (Pauza i Wznowienie) ---
        startY += 90;
        DodajNapis("4. NAudio (Start / Pauza / Resume)", startY);
        
        Button bStart = DodajPrzycisk("Start / Play", startY + 30, 20);
        bStart.Click += (s, e) => {
            // Jeśli czytnik nie istnieje, stwórz go
            if (audioReader == null) {
                audioReader = new AudioFileReader(mp3);
                waveOut.Init(audioReader);
            }
            waveOut.Play(); // Play działa też jako Resume po pauzie
        };

        Button bPause = DodajPrzycisk("Pauza", startY + 30, 130);
        bPause.Click += (s, e) => waveOut.Pause(); // Zatrzymuje, ale pamięta pozycję

        Button bReset = DodajPrzycisk("Reset", startY + 30, 240);
        bReset.Click += (s, e) => {
            waveOut.Stop();
            if (audioReader != null) audioReader.Position = 0; // Przewija na początek
        };
    }

    private void PokazNaglowekWav()
    {
        try {
            // Używamy NAudio do podejrzenia parametrów pliku
            using (var reader = new WaveFileReader(wav)) {
                var f = reader.WaveFormat;
                lblWavInfo.Text = $"Format: {f.Encoding} | {f.SampleRate}Hz | {f.BitsPerSample}bit | Kanały: {f.Channels}";
                lblWavInfo.ForeColor = Color.Blue;
            }
        } catch (Exception ex) {
            lblWavInfo.Text = "Błąd: Nie znaleziono pliku test.wav";
            lblWavInfo.ForeColor = Color.Red;
        }
    }

    private Button DodajPrzycisk(string tekst, int gora, int lewo) {
        Button b = new Button { Text = tekst, Top = gora, Left = lewo, Width = 100, Height = 35 };
        this.Controls.Add(b);
        return b;
    }

    private void DodajNapis(string tekst, int gora) {
        Label l = new Label { Text = tekst, Top = gora, Left = 20, AutoSize = true, Font = new Font("Arial", 9, FontStyle.Bold) };
        this.Controls.Add(l);
    }
}